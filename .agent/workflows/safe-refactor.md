---
description: 「機能を一切変えず、コードの構造だけを安全に改善したいとき」
---

# 🔧 Safe Refactoring Workflow

このワークフローは、既存の機能を破壊することなくコード構造を改善するための厳格な手順書です。
エージェントは、リファクタリングを行う際、以下のプロセスを**スキップすることなく**実行しなければなりません。

---

## 🚦 Phase 1: The Safety Net (安全網の構築)

コードを触る前に、現在の挙動が「正解」であることを保証するテストを確保せよ。

1.  **Check Coverage**: リファクタリング対象のファイルに関連するテストが存在するか確認する。
2.  **Create Golden Master**:
    *   テストが存在しない、または不十分な場合、現在の挙動をそのまま記録する「スナップショットテスト」または「E2Eテスト」を新規作成せよ。
    *   *目的*: 「良いコード」を書くことではなく、「現在の挙動が変わっていないこと」を機械的に検知するため。
3.  **Verify Baseline**: テストを実行し、**全て Green (Pass)** であることを確認してから次に進め。
    *   ❌ 既存テストが失敗している状態でリファクタリングを開始してはならない。

---

## 🛠️ Phase 2: The Refactor (構造の改善)

機能（振る舞い）を変えずに、内部構造だけを変更せよ。

1.  **Analyze**: 複雑度が高い箇所（ネストが深い、関数が長い、変数が不明瞭）を特定する。
2.  **Incremental Change**:
    *   一度に全てを書き換えるのではなく、**「関数単位」**や**「変数名の変更」**など、小さな単位で変更を行う。
    *   *Prohibition*: ロジックの変更と同時に「新機能の追加」を行ってはならない。
3.  **Keep it Working**: 変更を加えるたびにテストを実行し、Greenを維持せよ。

---

## ⚖️ Phase 3: Verification & Cleanup (検証と掃除)

1.  **Regression Test**: 全てのテストスイートを実行し、他の機能に副作用が出ていないか確認する。
2.  **Type Check**: `npm run type-check` を実行し、型定義に矛盾がないか確認する。
3.  **Cleanup**: Phase 1 で作成した一時的な「Golden Masterテスト」が不要であれば削除し、より堅牢な単体テストに置き換える。

---

## 🚨 Emergency Revert Protocol

もしリファクタリング中にテストが修復不可能なほど **Red (Fail)** になった場合：

1.  **Stop**: 無理に修正を続けようとするな。泥沼化する。
2.  **Revert**: `git checkout .` (または該当ファイルの復元) を行い、Phase 1 の状態に戻せ。
3.  **Report**: 「なぜリファクタリングに失敗したか」を分析し、ユーザーに報告せよ。
